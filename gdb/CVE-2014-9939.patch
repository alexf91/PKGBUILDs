From 7e27a9d5f22f9f7ead11738b1546d0b5c737266b Mon Sep 17 00:00:00 2001
From: "Yuriy M. Kaminskiy" <yumkam@gmail.com>
Date: Tue, 4 Aug 2015 16:51:53 +0100
Subject: [PATCH] Fix stack buffer overflows when parsing corrupt ihex files.

	PR binutils/18750
	* ihex.c (ihex_scan): Fixes incorrect escape sequence in error message
	and stack overflow when char is signed and \200-\376 was in place of hex
	digit; also fixes \377 was handled as EOF instead of "incorrect character".
	(ihex_read_section): Changed for consistency.
	(ihex_bad_byte): Prevent (now impossible to trigger) stack
	overflow and incorrect escape sequence handling.
	* srec.c (srec_bad_byte): Likewise.

	* readelf.c (process_mips_specific): Fix incorrect escape
	sequence handling.
---
 bfd/ChangeLog      | 12 ++++++++++++
 bfd/ihex.c         |  6 +++---
 bfd/srec.c         |  2 +-
 binutils/ChangeLog | 11 +++++++++++
 binutils/readelf.c |  2 +-
 5 files changed, 28 insertions(+), 5 deletions(-)

#diff --git a/bfd/ChangeLog b/bfd/ChangeLog
#index 986299d..a8b3646 100644
#--- a/bfd/ChangeLog
#+++ b/bfd/ChangeLog
#@@ -1,3 +1,15 @@
#+2015-08-04  Yuriy M. Kaminskiy"  <yumkam@gmail.com>
#+	    Tyler Hicks  <tyhicks@canonical.com>
#+
#+	PR binutils/18750
#+	* ihex.c (ihex_scan): Fixes incorrect escape sequence in error message
#+	and stack overflow when char is signed and \200-\376 was in place of hex
#+	digit; also fixes \377 was handled as EOF instead of "incorrect character".
#+	(ihex_read_section): Changed for consistency.
#+	(ihex_bad_byte): Prevent (now impossible to trigger) stack
#+	overflow and incorrect escape sequence handling.
#+	* srec.c (srec_bad_byte): Likewise.
#+
# 2015-08-03  Hans-Peter Nilsson  <hp@axis.com>
# 
# 	* elf32-cris.c (cris_elf_relocate_section)
Index: gdb-7.7.1/bfd/ihex.c
===================================================================
--- gdb-7.7.1.orig/bfd/ihex.c	2017-06-08 07:57:20.356481702 -0400
+++ gdb-7.7.1/bfd/ihex.c	2017-06-08 07:57:18.144454936 -0400
@@ -220,7 +220,7 @@ ihex_bad_byte (bfd *abfd, unsigned int l
       char buf[10];
 
       if (! ISPRINT (c))
-	sprintf (buf, "\\%03o", (unsigned int) c);
+	sprintf (buf, "\\%03o", (unsigned int) c & 0xff);
       else
 	{
 	  buf[0] = c;
@@ -277,7 +277,7 @@ ihex_scan (bfd *abfd)
       else
 	{
 	  file_ptr pos;
-	  char hdr[8];
+	  unsigned char hdr[8];
 	  unsigned int i;
 	  unsigned int len;
 	  bfd_vma addr;
@@ -554,7 +554,7 @@ ihex_read_section (bfd *abfd, asection *
   error = FALSE;
   while ((c = ihex_get_byte (abfd, &error)) != EOF)
     {
-      char hdr[8];
+      unsigned char hdr[8];
       unsigned int len;
       unsigned int type;
       unsigned int i;
Index: gdb-7.7.1/bfd/srec.c
===================================================================
--- gdb-7.7.1.orig/bfd/srec.c	2017-06-08 07:57:20.356481702 -0400
+++ gdb-7.7.1/bfd/srec.c	2017-06-08 07:57:19.244468248 -0400
@@ -251,7 +251,7 @@ srec_bad_byte (bfd *abfd,
       char buf[10];
 
       if (! ISPRINT (c))
-	sprintf (buf, "\\%03o", (unsigned int) c);
+	sprintf (buf, "\\%03o", (unsigned int) c & 0xff);
       else
 	{
 	  buf[0] = c;
